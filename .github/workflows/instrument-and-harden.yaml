name: instrument-and-harden-image

# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows: ["build-image"]
    types:
      - completed

jobs:
  instrument:
    runs-on: ubuntu-latest
    container: ubuntu
    steps:
      -
        name: Install Curl
        shell: bash
        run: 
          apt-get update; apt-get install curl -y;
      -
        name: Curl and build Slim SaaS CLI
        shell: bash
        run: |
          curl https://platform.zero.dev.saas.getslim.ai/.service/releases/slim/0.0.7-dev | sh
          ~/.slim/bin/slim config gen --save --token ${{ secrets.SLIM_TOKEN }}
      -
        name: Instrument the image
        shell: bash
        run: |
          ~/.slim/bin/slim --debug instrument \
          --stop-grace-period 999s  \
          ghcr.io/mritunjaysharma394/node-app:latest
  probe:
    needs: instrument
    runs-on: ubuntu-latest
    container: ubuntu
    services:
      # Label used to access the service container
      app-instrumented:
        # Container  image
          image: ghcr.io/mritunjaysharma394/node-app:latest-slim-instrumented
            #
          ports:
            # Opens tcp port 8080 on the host and service container
            - 8080:8080     
    steps:
      -
        name: Install Curl
        shell: bash
        run: 
          apt-get update; apt-get install curl -y;
      -
        name: Probe the container
        shell: bash
        run: |
          curl -v localhost:8080
  harden: 
    needs: [instrument,probe]
    runs-on: ubuntu-latest
    services:
      # Label used to access the service container
      app-instrumented:
        # Container  image
          image: ghcr.io/mritunjaysharma394/node-app:latest-slim-instrumented
            #
          ports:
            # Opens tcp port 8080 on the host and service container
            - 8080:8080     
    steps:
      -
        name: Curl and build Slim SaaS CLI
        shell: bash
        run: |
          curl https://platform.zero.dev.saas.getslim.ai/.service/releases/slim/0.0.7-dev | sh
          ~/.slim/bin/slim config gen --save --token ${{ secrets.SLIM_TOKEN }}
      -   
        name: Harden the instrumented container
        shell: bash
        run: |
          ~/.slim/bin/slim harden --instrumented-image ghcr.io/mritunjaysharma394/node-app:latest-slim-instrumented

  verify-harden:
    needs: [instrument, probe, harden]
    runs-on: ubuntu-latest
    container: ubuntu
    services:
      # Label used to access the service container
      app-instrumented:
        # Container  image
          image: ghcr.io/mritunjaysharma394/node-app:latest-slim-hardened
            #
          ports:
            # Opens tcp port 8080 on the host and service container
            - 8081:8080     
    steps:
      -
        name: Install Curl
        shell: bash
        run: 
          apt-get update; apt-get install curl -y;
      -
        name: Probe the container
        shell: bash
        run: |
          curl -v localhost:8081  